<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Bayesian Spatial Regression</title>
<meta name="description" content="katie jolly&#39;s portfolio site">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/owl.carousel.css">
<link rel="stylesheet" href="/css/owl.theme.css">


  <link href="/css/style.sea.css" rel="stylesheet" id="theme-stylesheet">

 

  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  


<link href="/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="/img/favicon.png">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-109851039-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              <div id="sidebar" class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas">
  <div class="sidebar-content">
    <h1 class="sidebar-heading"><a href="/">  katie jolly  </a></h1>
    
      <p class="sidebar-p">geographic data science, open <br> data, and information design //<br> saint paul, mn</p>
    
    <ul class="sidebar-menu">
      
        <li><a href="/portfolio/">Portfolio</a></li>
      
        <li><a href="http://katiejolly.io/blog/">Blog</a></li>
      
        <li><a href="/about/">About</a></li>
      
        <li><a href="/contact/">Get in touch</a></li>
      
    </ul>
    <p class="social">
  
  
  
  <a href="https://twitter.com/katiejolly6" data-animate-hover="pulse" class="external twitter">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  <a href="mailto:katiejolly6@gmail.com" data-animate-hover="pulse" class="email">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://www.linkedin.com/in/katie-jolly-6001987b/" data-animate-hover="pulse" class="external">
    <i class="fa fa-linkedin"></i>
  </a>
  
  
  
  <a href="https://github.com/katiejolly" data-animate-hover="pulse" class="external">
    <i class="fa fa-github"></i>
  </a>
  
  
</p>


    <div class="copyright">
      <p class="credit">
        
          &copy;2018 katie jolly
        
        | Template by <a href="https://bootstrapious.com/free-templates" class="external">Bootstrapious.com</a>

&amp; ported to Hugo by <a href="https://github.com/kishaningithub">Kishan B</a>

      </p>
    </div>
  </div>
</div>

              
<div class="col-xs-12 col-sm-8 col-md-9 content-column white-background">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="/">  katie jolly  </a></h1>
</div>

  <div class="row">
    <div class="col-lg-8">
      <div class="content-column-content">
         <h1>Bayesian Spatial Regression</h1>
         


<p>This project is about vaccine exemption rates in California kindergartens.</p>
<p><br>
<br></p>
<p>With the rise of the anti-vax movement, we are interested in what demographic factors might be connected or at higher risk. Previous research has shows that white, wealtier communities as well as certain immigrant communities are the most at-risk. We also acknowledge the spatial aspect of this data, making a spatial model more suitable.</p>
<p>My school level immunization data comes from the California Department of Health and is aggregated over the 2012-3013, 2013-2014, and 2014-2015 school years to smooth out some of the more unstable rates. My demographic data is Census data collected at the tract level. I use this data because it is the most reliable and standard. In order to connect these two datasets, I will do a spatial join to figure out which schools are in which census tracts.</p>
<p><br>
<br></p>
<div id="data-and-packages" class="section level2">
<h2>Data and packages</h2>
<pre class="r"><code>library(rjags)
library(tidyverse)
library(sf)
library(extrafont)

load(&quot;~/portfolio/static/data/04_spatial_joins_zcta.RData&quot;)

demographic_and_pbe_data_clean &lt;- demographic_and_pbe_data_zcta %&gt;%
  select(-c(57:61, 63)) %&gt;%
  select(-58) %&gt;%
  st_transform(26911) %&gt;%
  mutate_at(vars(c(2, 4:28)), funs(as.numeric)) %&gt;%
  mutate(percent_white = ifelse(is.nan(percent_white), NA, percent_white),
         weighted_mean_pbe_rate_zcta = ifelse(is.nan(weighted_mean_pbe_rate_zcta), NA, weighted_mean_pbe_rate_zcta),
         log_weighted_mean_pbe_rate_zcta = log(weighted_mean_pbe_rate_zcta + 0.001))

theme_katie &lt;- theme(text = element_text(family = &quot;Franklin Gothic Book&quot;, color = &quot;#041A26&quot;))</code></pre>
<p><strong>School level data on vaccination rates</strong></p>
<table>
<colgroup>
<col width="16%" />
<col width="83%" />
</colgroup>
<thead>
<tr class="header">
<th>Variable name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>street</td>
<td>Street address of school</td>
</tr>
<tr class="even">
<td>city</td>
<td>City of school</td>
</tr>
<tr class="odd">
<td>zip</td>
<td>9-digit zip code of school</td>
</tr>
<tr class="even">
<td>county_1</td>
<td>County of school</td>
</tr>
<tr class="odd">
<td>public_priv</td>
<td>Type of school (public or private)</td>
</tr>
<tr class="even">
<td>school_name</td>
<td>Name of school</td>
</tr>
<tr class="odd">
<td>lat_dec</td>
<td>Latitude</td>
</tr>
<tr class="even">
<td>lon_dec</td>
<td>Longitude</td>
</tr>
<tr class="odd">
<td>enroll_tot</td>
<td>Total enrollment over 2012-2013, 2013-2014, and 2014-2015</td>
</tr>
<tr class="even">
<td>pbe_tot</td>
<td>Total personal belief exemptions over 2012-2013, 2013-2014, and 2014-2015</td>
</tr>
<tr class="odd">
<td>pbe_rate</td>
<td>Total PBEs divided by total enrollment</td>
</tr>
</tbody>
</table>
<p><br>
<br></p>
<p><strong>Census zcta level demographic data</strong></p>
<table>
<colgroup>
<col width="22%" />
<col width="77%" />
</colgroup>
<thead>
<tr class="header">
<th>Variable name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>geoid</td>
<td>Unique identifier</td>
</tr>
<tr class="even">
<td>estimate_total_pop</td>
<td>Estimated total population in 2015</td>
</tr>
<tr class="odd">
<td>name</td>
<td>Name of census zcta</td>
</tr>
<tr class="even">
<td>moe_total_pop</td>
<td>Margin of error on total population estimate in 2015</td>
</tr>
<tr class="odd">
<td>estimate_total_bachelor_degree</td>
<td>Estimate of the total adult population with a bachelor’s degree as the highest form of education in 2015</td>
</tr>
<tr class="even">
<td>estimate_hs_diploma</td>
<td>Estimate of the total adult population with a high school diploma as the highest form of education in 2015</td>
</tr>
<tr class="odd">
<td>estimate_total_foreign_born</td>
<td>Estimate of the total population that was not born in the U.S.</td>
</tr>
<tr class="even">
<td>estimate_hh_med_income</td>
<td>Estimate of the household median income in 2015</td>
</tr>
<tr class="odd">
<td>estimate_total_pop_hisp</td>
<td>Estimate of the total Hispanic population in 2015</td>
</tr>
<tr class="even">
<td>estimate_median_age_total</td>
<td>Estimate of the median age in 2015</td>
</tr>
<tr class="odd">
<td>estimate_total_white_alone</td>
<td>Estimate of the population that identifies only as white in 2015</td>
</tr>
</tbody>
</table>
<p><br>
<br></p>
</div>
<div id="visualizations" class="section level2">
<h2>Visualizations</h2>
<p><br>
<br></p>
<pre><code>## 
  |                                                                       
  |                                                                 |   0%
  |                                                                       
  |                                                                 |   1%
  |                                                                       
  |=                                                                |   1%
  |                                                                       
  |=                                                                |   2%
  |                                                                       
  |==                                                               |   2%
  |                                                                       
  |==                                                               |   3%
  |                                                                       
  |==                                                               |   4%
  |                                                                       
  |===                                                              |   4%
  |                                                                       
  |===                                                              |   5%
  |                                                                       
  |====                                                             |   6%
  |                                                                       
  |====                                                             |   7%
  |                                                                       
  |=====                                                            |   7%
  |                                                                       
  |=====                                                            |   8%
  |                                                                       
  |======                                                           |   9%
  |                                                                       
  |======                                                           |  10%
  |                                                                       
  |=======                                                          |  10%
  |                                                                       
  |=======                                                          |  11%
  |                                                                       
  |========                                                         |  12%
  |                                                                       
  |========                                                         |  13%
  |                                                                       
  |=========                                                        |  13%
  |                                                                       
  |=========                                                        |  14%
  |                                                                       
  |=========                                                        |  15%
  |                                                                       
  |==========                                                       |  15%
  |                                                                       
  |==========                                                       |  16%
  |                                                                       
  |===========                                                      |  16%
  |                                                                       
  |===========                                                      |  17%
  |                                                                       
  |===========                                                      |  18%
  |                                                                       
  |============                                                     |  18%
  |                                                                       
  |============                                                     |  19%
  |                                                                       
  |=============                                                    |  20%
  |                                                                       
  |=============                                                    |  21%
  |                                                                       
  |==============                                                   |  21%
  |                                                                       
  |==============                                                   |  22%
  |                                                                       
  |===============                                                  |  22%
  |                                                                       
  |===============                                                  |  23%
  |                                                                       
  |===============                                                  |  24%
  |                                                                       
  |================                                                 |  24%
  |                                                                       
  |================                                                 |  25%
  |                                                                       
  |=================                                                |  25%
  |                                                                       
  |=================                                                |  26%
  |                                                                       
  |=================                                                |  27%
  |                                                                       
  |==================                                               |  27%
  |                                                                       
  |==================                                               |  28%
  |                                                                       
  |===================                                              |  29%
  |                                                                       
  |===================                                              |  30%
  |                                                                       
  |====================                                             |  30%
  |                                                                       
  |====================                                             |  31%
  |                                                                       
  |====================                                             |  32%
  |                                                                       
  |=====================                                            |  32%
  |                                                                       
  |=====================                                            |  33%
  |                                                                       
  |======================                                           |  33%
  |                                                                       
  |======================                                           |  34%
  |                                                                       
  |=======================                                          |  35%
  |                                                                       
  |=======================                                          |  36%
  |                                                                       
  |========================                                         |  36%
  |                                                                       
  |========================                                         |  37%
  |                                                                       
  |========================                                         |  38%
  |                                                                       
  |=========================                                        |  38%
  |                                                                       
  |=========================                                        |  39%
  |                                                                       
  |==========================                                       |  39%
  |                                                                       
  |==========================                                       |  40%
  |                                                                       
  |==========================                                       |  41%
  |                                                                       
  |===========================                                      |  41%
  |                                                                       
  |===========================                                      |  42%
  |                                                                       
  |============================                                     |  42%
  |                                                                       
  |============================                                     |  43%
  |                                                                       
  |============================                                     |  44%
  |                                                                       
  |=============================                                    |  44%
  |                                                                       
  |=============================                                    |  45%
  |                                                                       
  |==============================                                   |  46%
  |                                                                       
  |==============================                                   |  47%
  |                                                                       
  |===============================                                  |  47%
  |                                                                       
  |===============================                                  |  48%
  |                                                                       
  |================================                                 |  49%
  |                                                                       
  |================================                                 |  50%
  |                                                                       
  |=================================                                |  50%
  |                                                                       
  |=================================                                |  51%
  |                                                                       
  |==================================                               |  52%
  |                                                                       
  |==================================                               |  53%
  |                                                                       
  |===================================                              |  53%
  |                                                                       
  |===================================                              |  54%
  |                                                                       
  |===================================                              |  55%
  |                                                                       
  |====================================                             |  55%
  |                                                                       
  |====================================                             |  56%
  |                                                                       
  |=====================================                            |  56%
  |                                                                       
  |=====================================                            |  57%
  |                                                                       
  |======================================                           |  58%
  |                                                                       
  |======================================                           |  59%
  |                                                                       
  |=======================================                          |  59%
  |                                                                       
  |=======================================                          |  60%
  |                                                                       
  |========================================                         |  61%
  |                                                                       
  |========================================                         |  62%
  |                                                                       
  |=========================================                        |  62%
  |                                                                       
  |=========================================                        |  63%
  |                                                                       
  |=========================================                        |  64%
  |                                                                       
  |==========================================                       |  64%
  |                                                                       
  |==========================================                       |  65%
  |                                                                       
  |===========================================                      |  65%
  |                                                                       
  |===========================================                      |  66%
  |                                                                       
  |===========================================                      |  67%
  |                                                                       
  |============================================                     |  67%
  |                                                                       
  |============================================                     |  68%
  |                                                                       
  |=============================================                    |  69%
  |                                                                       
  |=============================================                    |  70%
  |                                                                       
  |==============================================                   |  70%
  |                                                                       
  |==============================================                   |  71%
  |                                                                       
  |===============================================                  |  72%
  |                                                                       
  |===============================================                  |  73%
  |                                                                       
  |================================================                 |  73%
  |                                                                       
  |================================================                 |  74%
  |                                                                       
  |=================================================                |  75%
  |                                                                       
  |=================================================                |  76%
  |                                                                       
  |==================================================               |  76%
  |                                                                       
  |==================================================               |  77%
  |                                                                       
  |==================================================               |  78%
  |                                                                       
  |===================================================              |  78%
  |                                                                       
  |===================================================              |  79%
  |                                                                       
  |====================================================             |  79%
  |                                                                       
  |====================================================             |  80%
  |                                                                       
  |====================================================             |  81%
  |                                                                       
  |=====================================================            |  81%
  |                                                                       
  |=====================================================            |  82%
  |                                                                       
  |======================================================           |  83%
  |                                                                       
  |======================================================           |  84%
  |                                                                       
  |=======================================================          |  84%
  |                                                                       
  |=======================================================          |  85%
  |                                                                       
  |========================================================         |  86%
  |                                                                       
  |========================================================         |  87%
  |                                                                       
  |=========================================================        |  87%
  |                                                                       
  |=========================================================        |  88%
  |                                                                       
  |==========================================================       |  89%
  |                                                                       
  |==========================================================       |  90%
  |                                                                       
  |===========================================================      |  90%
  |                                                                       
  |===========================================================      |  91%
  |                                                                       
  |===========================================================      |  92%
  |                                                                       
  |============================================================     |  92%
  |                                                                       
  |============================================================     |  93%
  |                                                                       
  |=============================================================    |  93%
  |                                                                       
  |=============================================================    |  94%
  |                                                                       
  |==============================================================   |  95%
  |                                                                       
  |==============================================================   |  96%
  |                                                                       
  |===============================================================  |  96%
  |                                                                       
  |===============================================================  |  97%
  |                                                                       
  |================================================================ |  98%
  |                                                                       
  |================================================================ |  99%
  |                                                                       
  |=================================================================|  99%
  |                                                                       
  |=================================================================| 100%</code></pre>
<pre class="r"><code>ggplot() + 
  geom_sf(data = outline, fill = &quot;#F4ECD6&quot;, color = &quot;#EDD38B&quot;) + 
  geom_sf(data = demographic_and_pbe_data_zcta, aes(fill = weighted_mean_pbe_rate_zcta), color = &quot;#D1D1D1&quot;) +
  scale_fill_gradient(low = &quot;#BCD4DE&quot;, high = &quot;#310A31&quot;, name = &quot;Weighted mean PBE rate&quot;, na.value = &quot;#F4ECD6&quot;) + theme_minimal() + theme(text = element_text(family = &quot;Franklin Gothic Book&quot;), panel.grid.major = element_line(&quot;transparent&quot;)) + labs(title = &quot;PBE rates across California zip codes&quot;) +
    theme(legend.direction = &quot;horizontal&quot;, legend.position = &quot;bottom&quot;,
          axis.text = element_blank())</code></pre>
<p><img src="/portfolio/bayesian-spatial-modeling_files/figure-html/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br>
<br></p>
<pre class="r"><code>ggplot(demographic_and_pbe_data_clean, aes(x = schools)) +
  geom_histogram(aes(y = ..density..), binwidth = 1, fill = &quot;#F1E8B8&quot;, color = &quot;white&quot;) +
  geom_density(color = &quot;#D05353&quot; ) +
  theme_minimal() +
  theme(text = element_text(family = &quot;Franklin Gothic Book&quot;)) +
  labs(title = &quot;Most zip codes have only a few schools, and the most common number is one&quot;, x= &quot;Number of schools&quot;, y = &quot;Density&quot;) +
  scale_x_continuous(breaks = c(1, 5, 10, 15))</code></pre>
<p><img src="/portfolio/bayesian-spatial-modeling_files/figure-html/unnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br>
<br></p>
<pre class="r"><code>ggplot(demographic_and_pbe_data_clean, aes(x = percent_white, y = weighted_mean_pbe_rate_zcta)) +
  geom_point(color = &quot;#E58F65&quot;) +
  geom_smooth(color = &quot;#D05353&quot;) +
  theme_minimal() + 
  theme(text = element_text(family = &quot;Franklin Gothic Book&quot;)) +
  labs(title = &quot;In general higher white populations are more likely to have \nmore personal belief exemptions&quot;)</code></pre>
<p><img src="/portfolio/bayesian-spatial-modeling_files/figure-html/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br>
<br></p>
</div>
<div id="modeling" class="section level2">
<h2>Modeling</h2>
<p><br>
<br></p>
<p>I start by modeling the relationship between the percent of a zip code’s population that is white according to the Census and the weighted mean personal belief exemption in a zip code.</p>
<p><span class="math display">\[\text{weighted mean pbe rate} = \beta_0 + \beta_1 * \text{percent white}\]</span></p>
<pre class="r"><code>library(rjags)

clean_data &lt;- demographic_and_pbe_data_clean %&gt;%
  st_set_geometry(NULL) %&gt;%
  select(weighted_mean_pbe_rate_zcta, percent_white) %&gt;%
  tidyr::drop_na()


# Define the model
pbe_model &lt;- &quot;model{
    #Data
    for(i in 1:length(y)) {
        y[i] ~ dnorm(mu[i], tau)
        mu[i] &lt;- beta0 + beta1*x[i]         
    }

    #Priors
    beta0 ~ dnorm(m0, t0)
    beta1 ~ dnorm(m1, t1)
    tau   ~ dgamma(s, r)
}&quot;
    
    
# Compile the model
pbe_jags &lt;- jags.model(textConnection(pbe_model), 
    data = list(y = clean_data$weighted_mean_pbe_rate_zcta, x = clean_data$percent_white, m0 = 0, t0 = 1/(10^2), m1 = 0.1, t1 = 1/(10^2), s = 10, r = 30000000),
    inits=list(.RNG.name=&quot;base::Wichmann-Hill&quot;, .RNG.seed=454))</code></pre>
<pre><code>## Compiling model graph
##    Resolving undeclared variables
##    Allocating nodes
## Graph information:
##    Observed stochastic nodes: 1316
##    Unobserved stochastic nodes: 3
##    Total graph size: 5269
## 
## Initializing model</code></pre>
<pre class="r"><code># Simulate the model
pbe_sim &lt;- coda.samples(pbe_jags,
    variable.names=c(&quot;beta0&quot;,&quot;beta1&quot;,&quot;tau&quot;), 
    n.iter=10000)


# Quick plot
plot(pbe_sim)</code></pre>
<p><img src="/portfolio/bayesian-spatial-modeling_files/figure-html/unnamed-chunk-6-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p><br>
<br></p>
<pre class="r"><code>pbe_chains &lt;- data.frame(iteration = 1:10000, pbe_sim[[1]])

cred_interval &lt;- pbe_chains %&gt;%
  summarise(min = quantile(beta1, 0.025), max = quantile(beta1, 0.975))

ggplot(pbe_chains, aes(x = beta1)) +
  geom_histogram(fill = &quot;#E58F65&quot;, color = &quot;white&quot;) +
  theme_minimal() +
  geom_vline(xintercept = cred_interval$min[1]) +
  geom_vline(xintercept = cred_interval$max[1]) +
  theme_katie +
  labs()</code></pre>
<p><img src="/portfolio/bayesian-spatial-modeling_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br>
<br></p>
<p>Based on this credible interval we cannot say that there is a detectable linear relationship between percent white and pbe rate.</p>
<p>Next I will model the relationship between both percent white &amp; household median income and pbe rate.</p>
<p><span class="math display">\[\text{weighted mean pbe rate} = \beta_0 + \beta_1 * \text{percent white} + \beta_2 * \text{household median income}\]</span></p>
<p><br>
<br></p>
<pre class="r"><code>clean_data &lt;- demographic_and_pbe_data_clean %&gt;%
  st_set_geometry(NULL) %&gt;%
  select(weighted_mean_pbe_rate_zcta, percent_white, estimate_hh_med_income) %&gt;%
  tidyr::drop_na()


# Define the model
pbe_model &lt;- &quot;model{
    #Data
    for(i in 1:length(y)) {
        y[i] ~ dnorm(mu[i], tau)
        mu[i] &lt;- beta0 + beta1*x[i] + beta2*z[i]        
    }

    #Priors
    beta0 ~ dnorm(m0, t0)
    beta1 ~ dnorm(m1, t1)
    beta2 ~ dnorm(m1, t1)
    tau   ~ dgamma(s, r)
}&quot;
    
    
# Compile the model
pbe_jags &lt;- jags.model(textConnection(pbe_model), 
    data = list(y = clean_data$weighted_mean_pbe_rate_zcta, x = clean_data$percent_white, z = clean_data$estimate_hh_med_income, m0 = 0, t0 = 1, m1 = 0.1, t1 = 1, s = 10, r = 30000000),
    inits=list(.RNG.name=&quot;base::Wichmann-Hill&quot;, .RNG.seed=454))</code></pre>
<pre><code>## Compiling model graph
##    Resolving undeclared variables
##    Allocating nodes
## Graph information:
##    Observed stochastic nodes: 1312
##    Unobserved stochastic nodes: 4
##    Total graph size: 7865
## 
## Initializing model</code></pre>
<pre class="r"><code># Simulate the model
pbe_sim &lt;- coda.samples(pbe_jags,
    variable.names=c(&quot;beta0&quot;,&quot;beta1&quot;, &quot;beta2&quot;, &quot;tau&quot;), 
    n.iter=10000)


# Quick plot
plot(pbe_sim)</code></pre>
<p><img src="/portfolio/bayesian-spatial-modeling_files/figure-html/unnamed-chunk-8-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p><br>
<br></p>
<p>Based on the trace plots from this model, neither the percent white or household median income have a significant linear relationship with pbe rate.</p>
</div>
<div id="subsetting-the-data" class="section level2">
<h2>Subsetting the data</h2>
<p>After I made these initial models, I decided I wanted to subset the data to only a few metro areas: Los Angeles, San Diego, and San Francisco.</p>
<pre><code>## 
  |                                                                       
  |                                                                 |   0%
  |                                                                       
  |                                                                 |   1%
  |                                                                       
  |=                                                                |   1%
  |                                                                       
  |=                                                                |   2%
  |                                                                       
  |==                                                               |   2%
  |                                                                       
  |==                                                               |   3%
  |                                                                       
  |==                                                               |   4%
  |                                                                       
  |===                                                              |   4%
  |                                                                       
  |===                                                              |   5%
  |                                                                       
  |====                                                             |   5%
  |                                                                       
  |====                                                             |   6%
  |                                                                       
  |====                                                             |   7%
  |                                                                       
  |=====                                                            |   7%
  |                                                                       
  |=====                                                            |   8%
  |                                                                       
  |======                                                           |   8%
  |                                                                       
  |======                                                           |   9%
  |                                                                       
  |======                                                           |  10%
  |                                                                       
  |=======                                                          |  10%
  |                                                                       
  |=======                                                          |  11%
  |                                                                       
  |=======                                                          |  12%
  |                                                                       
  |========                                                         |  12%
  |                                                                       
  |========                                                         |  13%
  |                                                                       
  |=========                                                        |  13%
  |                                                                       
  |=========                                                        |  14%
  |                                                                       
  |=========                                                        |  15%
  |                                                                       
  |==========                                                       |  15%
  |                                                                       
  |==========                                                       |  16%
  |                                                                       
  |===========                                                      |  16%
  |                                                                       
  |===========                                                      |  17%
  |                                                                       
  |===========                                                      |  18%
  |                                                                       
  |============                                                     |  18%
  |                                                                       
  |============                                                     |  19%
  |                                                                       
  |=============                                                    |  19%
  |                                                                       
  |=============                                                    |  20%
  |                                                                       
  |=============                                                    |  21%
  |                                                                       
  |==============                                                   |  21%
  |                                                                       
  |==============                                                   |  22%
  |                                                                       
  |===============                                                  |  22%
  |                                                                       
  |===============                                                  |  23%
  |                                                                       
  |===============                                                  |  24%
  |                                                                       
  |================                                                 |  24%
  |                                                                       
  |================                                                 |  25%
  |                                                                       
  |=================                                                |  25%
  |                                                                       
  |=================                                                |  26%
  |                                                                       
  |=================                                                |  27%
  |                                                                       
  |==================                                               |  27%
  |                                                                       
  |==================                                               |  28%
  |                                                                       
  |===================                                              |  28%
  |                                                                       
  |===================                                              |  29%
  |                                                                       
  |===================                                              |  30%
  |                                                                       
  |====================                                             |  30%
  |                                                                       
  |====================                                             |  31%
  |                                                                       
  |====================                                             |  32%
  |                                                                       
  |=====================                                            |  32%
  |                                                                       
  |=====================                                            |  33%
  |                                                                       
  |======================                                           |  33%
  |                                                                       
  |======================                                           |  34%
  |                                                                       
  |======================                                           |  35%
  |                                                                       
  |=======================                                          |  35%
  |                                                                       
  |=======================                                          |  36%
  |                                                                       
  |========================                                         |  36%
  |                                                                       
  |========================                                         |  37%
  |                                                                       
  |========================                                         |  38%
  |                                                                       
  |=========================                                        |  38%
  |                                                                       
  |=========================                                        |  39%
  |                                                                       
  |==========================                                       |  39%
  |                                                                       
  |==========================                                       |  40%
  |                                                                       
  |==========================                                       |  41%
  |                                                                       
  |===========================                                      |  41%
  |                                                                       
  |===========================                                      |  42%
  |                                                                       
  |============================                                     |  42%
  |                                                                       
  |============================                                     |  43%
  |                                                                       
  |============================                                     |  44%
  |                                                                       
  |=============================                                    |  44%
  |                                                                       
  |=============================                                    |  45%
  |                                                                       
  |==============================                                   |  45%
  |                                                                       
  |==============================                                   |  46%
  |                                                                       
  |==============================                                   |  47%
  |                                                                       
  |===============================                                  |  47%
  |                                                                       
  |===============================                                  |  48%
  |                                                                       
  |================================                                 |  48%
  |                                                                       
  |================================                                 |  49%
  |                                                                       
  |================================                                 |  50%
  |                                                                       
  |=================================                                |  50%
  |                                                                       
  |=================================                                |  51%
  |                                                                       
  |=================================                                |  52%
  |                                                                       
  |==================================                               |  52%
  |                                                                       
  |==================================                               |  53%
  |                                                                       
  |===================================                              |  53%
  |                                                                       
  |===================================                              |  54%
  |                                                                       
  |===================================                              |  55%
  |                                                                       
  |====================================                             |  55%
  |                                                                       
  |====================================                             |  56%
  |                                                                       
  |=====================================                            |  56%
  |                                                                       
  |=====================================                            |  57%
  |                                                                       
  |=====================================                            |  58%
  |                                                                       
  |======================================                           |  58%
  |                                                                       
  |======================================                           |  59%
  |                                                                       
  |=======================================                          |  59%
  |                                                                       
  |=======================================                          |  60%
  |                                                                       
  |=======================================                          |  61%
  |                                                                       
  |========================================                         |  61%
  |                                                                       
  |========================================                         |  62%
  |                                                                       
  |=========================================                        |  62%
  |                                                                       
  |=========================================                        |  63%
  |                                                                       
  |=========================================                        |  64%
  |                                                                       
  |==========================================                       |  64%
  |                                                                       
  |==========================================                       |  65%
  |                                                                       
  |===========================================                      |  65%
  |                                                                       
  |===========================================                      |  66%
  |                                                                       
  |===========================================                      |  67%
  |                                                                       
  |============================================                     |  67%
  |                                                                       
  |============================================                     |  68%
  |                                                                       
  |=============================================                    |  68%
  |                                                                       
  |=============================================                    |  69%
  |                                                                       
  |=============================================                    |  70%
  |                                                                       
  |==============================================                   |  70%
  |                                                                       
  |==============================================                   |  71%
  |                                                                       
  |==============================================                   |  72%
  |                                                                       
  |===============================================                  |  72%
  |                                                                       
  |===============================================                  |  73%
  |                                                                       
  |================================================                 |  73%
  |                                                                       
  |================================================                 |  74%
  |                                                                       
  |================================================                 |  75%
  |                                                                       
  |=================================================                |  75%
  |                                                                       
  |=================================================                |  76%
  |                                                                       
  |==================================================               |  76%
  |                                                                       
  |==================================================               |  77%
  |                                                                       
  |==================================================               |  78%
  |                                                                       
  |===================================================              |  78%
  |                                                                       
  |===================================================              |  79%
  |                                                                       
  |====================================================             |  79%
  |                                                                       
  |====================================================             |  80%
  |                                                                       
  |====================================================             |  81%
  |                                                                       
  |=====================================================            |  81%
  |                                                                       
  |=====================================================            |  82%
  |                                                                       
  |======================================================           |  82%
  |                                                                       
  |======================================================           |  83%
  |                                                                       
  |======================================================           |  84%
  |                                                                       
  |=======================================================          |  84%
  |                                                                       
  |=======================================================          |  85%
  |                                                                       
  |========================================================         |  85%
  |                                                                       
  |========================================================         |  86%
  |                                                                       
  |========================================================         |  87%
  |                                                                       
  |=========================================================        |  87%
  |                                                                       
  |=========================================================        |  88%
  |                                                                       
  |==========================================================       |  88%
  |                                                                       
  |==========================================================       |  89%
  |                                                                       
  |==========================================================       |  90%
  |                                                                       
  |===========================================================      |  90%
  |                                                                       
  |===========================================================      |  91%
  |                                                                       
  |===========================================================      |  92%
  |                                                                       
  |============================================================     |  92%
  |                                                                       
  |============================================================     |  93%
  |                                                                       
  |=============================================================    |  93%
  |                                                                       
  |=============================================================    |  94%
  |                                                                       
  |=============================================================    |  95%
  |                                                                       
  |==============================================================   |  95%
  |                                                                       
  |==============================================================   |  96%
  |                                                                       
  |===============================================================  |  96%
  |                                                                       
  |===============================================================  |  97%
  |                                                                       
  |===============================================================  |  98%
  |                                                                       
  |================================================================ |  98%
  |                                                                       
  |================================================================ |  99%
  |                                                                       
  |=================================================================|  99%
  |                                                                       
  |=================================================================| 100%</code></pre>
<p>I was then interested in whether or not there is actually clustering in the weighted mean pbe rates across these areas.</p>
<pre class="r"><code># morans i: global clustering
library(spdep)
library(ape)
st_rook = function(a, b = a) st_relate(a, b, pattern = &quot;F***1****&quot;)

pbe_data &lt;- demo_pbe_data_small %&gt;%
  mutate(weighted_mean_pbe_rate_zcta_clean = replace_na(weighted_mean_pbe_rate_zcta, 0)) %&gt;%
  mutate(NB_ROOK = st_rook(.)) 

for (i in 1:nrow(pbe_data)){
  pbe_data$nb_length[i] &lt;- length(pbe_data$NB_ROOK[[i]])
}

pbe_data &lt;- pbe_data %&gt;%
  select(-NB_ROOK) %&gt;%
  filter(nb_length &gt; 0)

ggplot(pbe_data) + geom_sf(fill = &quot;#51A3A3&quot;, color = &quot;#ADD3D3&quot;) + theme_minimal() +
  theme(panel.grid.major = element_line(&quot;transparent&quot;)) +
  theme(text = element_text(family = &quot;Segoe UI Light&quot;),
        axis.text = element_blank()) +
  labs(title = &quot;Zip codes with at least one neighbor&quot;)</code></pre>
<p><img src="/portfolio/bayesian-spatial-modeling_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>pbe_sp &lt;- as(pbe_data, &quot;Spatial&quot;)
pbe_nb &lt;- poly2nb(pbe_sp)
pbe_w &lt;- nb2listw(pbe_nb, style = &quot;B&quot;)

moran.mc(pbe_sp$weighted_mean_pbe_rate_zcta_clean, pbe_w, nsim = 9999) # mc simulations</code></pre>
<pre><code>## 
##  Monte-Carlo simulation of Moran I
## 
## data:  pbe_sp$weighted_mean_pbe_rate_zcta_clean 
## weights: pbe_w  
## number of simulations + 1: 10000 
## 
## statistic = 0.2208, observed rank = 10000, p-value = 1e-04
## alternative hypothesis: greater</code></pre>
<p>I did a hypothesis test of whether of not there is positive spatial autocorrelation (clustering) in these metropolitan areas.</p>
<p><span class="math display">\[H_0: I=0, \text{ completely spatially random}\\
H_a: I &gt; 0, \text{ spatially clustered} \]</span></p>
<p>To test this hypothesis I did a Monte Carlo test. This test randomly assigns values to the polygons in my data and calculates Moran’s I for each of these iterations. It then finds where our observed statistic falls in this distribution of possible statistics. My simulation included 10,000 iterations and found that the clustering in my observed data was more extreme than any of the random distributions, meaning we can reject the null hypothesis that there the data are completely spatially random. This means that spatial models are worthwhile for doing a regression analysis.</p>
<p>Before doing that, though, I am also interested in local hotspots and outliers in the data. To calculate this I will use local Moran’s I. This statistic essentially looks for groups of observations that are far above or below the expected value.</p>
<pre class="r"><code># create  Queens contiguity matrix
spatmatrix &lt;- poly2nb(pbe_sp)

# create a neighbours list with spatial weights
listw &lt;- nb2listw(spatmatrix)

# calculate the local moran of the distribution of white population
lmoran &lt;- localmoran(pbe_sp$weighted_mean_pbe_rate_zcta_clean, listw)
summary(lmoran)</code></pre>
<pre><code>##        Ii                 E.Ii               Var.Ii       
##  Min.   :-6.346199   Min.   :-0.001056   Min.   :0.03259  
##  1st Qu.:-0.003083   1st Qu.:-0.001056   1st Qu.:0.12075  
##  Median : 0.092672   Median :-0.001056   Median :0.16134  
##  Mean   : 0.237816   Mean   :-0.001056   Mean   :0.19262  
##  3rd Qu.: 0.257428   3rd Qu.:-0.001056   3rd Qu.:0.20598  
##  Max.   :28.184061   Max.   :-0.001056   Max.   :0.97303  
##       Z.Ii             Pr(z &gt; 0)     
##  Min.   :-12.88484   Min.   :0.0000  
##  1st Qu.: -0.00458   1st Qu.:0.2555  
##  Median :  0.23430   Median :0.4074  
##  Mean   :  0.59489   Mean   :0.3969  
##  3rd Qu.:  0.65739   3rd Qu.:0.5018  
##  Max.   : 40.42919   Max.   :1.0000</code></pre>
<pre class="r"><code># padronize the variable and save it to a new column
pbe_sp$s_pbe &lt;- scale(pbe_sp$weighted_mean_pbe_rate_zcta_clean)  %&gt;% as.vector()

# create a spatially lagged variable and save it to a new column
pbe_sp$lag_s_pbe &lt;- lag.listw(listw, pbe_sp$s_pbe)

# summary of variables, to inform the analysis
summary(pbe_sp$s_pbe)</code></pre>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
## -0.6694 -0.5950 -0.3154  0.0000  0.1759  9.4704</code></pre>
<pre class="r"><code>summary(pbe_sp$lag_s_pbe)</code></pre>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
## -0.6694 -0.3910 -0.1262  0.0623  0.2439  5.6576</code></pre>
<pre class="r"><code># create a new variable identifying the moran plot quadrant for each observation, dismissing the non-significant ones
pbe_sp$quad_sig &lt;- NA

# high-high quadrant
pbe_sp[(pbe_sp$s_pbe &gt;= 0 &amp; 
                 pbe_sp$lag_s_pbe &gt;= 0) &amp; 
                (lmoran[, 5] &lt;= 0.05), &quot;quad_sig&quot;] &lt;- &quot;high-high&quot;
# low-low quadrant
pbe_sp[(pbe_sp$s_pbe &lt;= 0 &amp; 
                 pbe_sp$lag_s_pbe &lt;= 0) &amp; 
                (lmoran[, 5] &lt;= 0.05), &quot;quad_sig&quot;] &lt;- &quot;low-low&quot;
# high-low quadrant
pbe_sp[(pbe_sp$s_pbe &gt;= 0 &amp; 
                 pbe_sp$lag_s_pbe &lt;= 0) &amp; 
                (lmoran[, 5] &lt;= 0.05), &quot;quad_sig&quot;] &lt;- &quot;high-low&quot;
# low-high quadrant
pbe_sp@data[(pbe_sp$s_pbe &lt;= 0 
               &amp; pbe_sp$lag_s_pbe &gt;= 0) &amp; 
                (lmoran[, 5] &lt;= 0.05), &quot;quad_sig&quot;] &lt;- &quot;low-high&quot;
# non-significant observations
pbe_sp@data[(lmoran[, 5] &gt; 0.05), &quot;quad_sig&quot;] &lt;- &quot;not signif.&quot;  

pbe_sp$quad_sig &lt;- as.factor(pbe_sp$quad_sig)
pbe_sp@data$id &lt;- rownames(pbe_sp@data)

# plotting the map
df &lt;- fortify(pbe_sp, region=&quot;id&quot;)
df &lt;- left_join(df, pbe_sp@data)
df %&gt;% 
  ggplot(aes(long, lat, group = group, fill = quad_sig)) + 
  geom_polygon(color = &quot;white&quot;, size = .05)  + coord_equal() + 
  theme_void() +
  theme(text = element_text(family = &quot;Segoe UI Light&quot;)) + 
  scale_fill_manual(values = c(&quot;#DD7373&quot;, &quot;#D1d1d1&quot;), name = &quot;Cluster type&quot;) +
  labs(title = &quot;Local spatial autocorrelation in PBE rates&quot;)</code></pre>
<p><img src="/portfolio/bayesian-spatial-modeling_files/figure-html/unnamed-chunk-11-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The areas highlighted in red are hotspots of high PBE rates.</p>
</div>

         <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "@katie_jolly" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
         
      </div>
    </div>
  </div>
</div>

          </div>
      </div>
  </div>
  <script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.cookie.js"> </script>
<script src="/js/ekko-lightbox.js"></script>
<script src="/js/jquery.scrollTo.min.js"></script>
<script src="/js/masonry.pkgd.min.js"></script>
<script src="/js/imagesloaded.pkgd.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/front.js"></script>

</body>
</html>
